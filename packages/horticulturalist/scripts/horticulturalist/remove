#!/bin/sh
source '/boot/include/package'

remove_couch_user()
{
  echo "Removing couchdb user ${PACKAGE_NAME}"
  local couch_as_concierge=$(get_couchdb_as_concierge_url)
  curl -X DELETE "${couch_as_concierge}/_config/admins/${PACKAGE_NAME}" >/dev/null 2>&1
  # todo error catching?
}

remove()
{
  local self="`realpath "$0"`"
  local base="`dirname -- "$self"`"

  source "$base/../medic-core/env" &&
  merge_environment /srv &&
  \
  source "$base/env" &&
  merge_environment /srv || return 255

  echo "Removing version $PACKAGE_VERSION."

  rm -rf "$PACKAGE_SETTINGS" \
    "$PACKAGE_SCRIPTS" "$PACKAGE_STORAGE"/*/logs

  package_remove_empty_directories "$PACKAGE_NAME"

  remove_couch_user

  return "$?"
}

remove "$@"
exit "$?"

